<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Proctoring Workspace Validator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #000;
            position: fixed;
        }
        
        .fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        
        header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            z-index: 10;
        }
        
        h1 {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .status-indicators {
            position: absolute;
            top: 3rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            z-index: 10;
        }
        
        .indicator {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
        }
        
        .indicator.success .indicator-icon {
            color: #10b981;
        }
        
        .indicator.error .indicator-icon {
            color: #ef4444;
        }
        
        .indicator-icon {
            margin-right: 0.5rem;
        }
        
        .indicator-text {
            font-size: 0.75rem;
        }
        
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
        }
        
        .instructions {
            position: absolute;
            bottom: 5rem;
            left: 1rem;
            right: 1rem;
            font-size: 0.875rem;
            padding: 0.75rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 0.375rem;
            z-index: 10;
        }
        
        .instructions ul {
            list-style-type: disc;
            padding-left: 1.25rem;
        }
        
        .instructions li {
            margin: 0.25rem 0;
        }
        
        .camera-status {
            position: absolute;
            bottom: 1rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            z-index: 10;
        }
        
        .fullscreen-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: white;
            z-index: 15;
            cursor: pointer;
        }
        
        .captured-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        .captured-view h2 {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .captured-image {
            max-width: 90%;
            max-height: 60vh;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            border: 2px solid white;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #2563eb;
        }
        
        button.success {
            background-color: #10b981;
        }
        
        button.success:hover {
            background-color: #059669;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="fullscreen-container">
        <header>
            <h1>Workspace Validation</h1>
        </header>
        
        <button id="fullscreen-button" class="fullscreen-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </button>
        
        <div class="status-indicators">
            <div id="landscape-indicator" class="indicator error">
                <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span class="indicator-text">Landscape</span>
            </div>
            <div id="qr-indicator" class="indicator error">
                <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span class="indicator-text">QR Code</span>
            </div>
            <div id="alignment-indicator" class="indicator error">
                <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <span class="indicator-text">Aligned</span>
            </div>
        </div>
        
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="instructions">
            <p>Instructions:</p>
            <ul>
                <li>Hold your phone in landscape mode</li>
                <li>Make sure the QR code from your computer screen is visible</li>
                <li>Align the QR code with the blue guide square</li>
                <li>Photo will be taken automatically when properly aligned</li>
            </ul>
        </div>
        
        <div class="camera-status">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                <circle cx="12" cy="13" r="3"></circle>
            </svg>
            <span>Camera active - align with guide</span>
        </div>
    </div>
    
    <div id="captured-view" class="captured-view hidden">
        <h2>Workspace Captured!</h2>
        <img id="captured-image" class="captured-image" alt="Captured Workspace">
        <div class="button-group">
            <button id="retake-button">Retake Photo</button>
            <button id="continue-button" class="success">Continue to Exam</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const capturedImage = document.getElementById('captured-image');
            const capturedView = document.getElementById('captured-view');
            const retakeButton = document.getElementById('retake-button');
            const continueButton = document.getElementById('continue-button');
            const fullscreenButton = document.getElementById('fullscreen-button');
            
            // Status indicators
            const landscapeIndicator = document.getElementById('landscape-indicator');
            const qrIndicator = document.getElementById('qr-indicator');
            const alignmentIndicator = document.getElementById('alignment-indicator');
            
            let stream = null;
            let intervalId = null;
            
            // Success indicator SVG
            const successSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="indicator-icon"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            
            // Error indicator SVG
            const errorSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="indicator-icon"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;

            // Create a QR code (for ghost image)
            function createQRCode(text, size) {
                // This is a simple representation of a QR code for visual reference
                // Not an actual QR code generator
                const qrSize = size || 100;
                const canvas = document.createElement('canvas');
                canvas.width = qrSize;
                canvas.height = qrSize;
                const qrCtx = canvas.getContext('2d');
                
                // Draw QR code background
                qrCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                qrCtx.fillRect(0, 0, qrSize, qrSize);
                
                // Draw position detection patterns (corners)
                qrCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                
                // Top-left corner
                qrCtx.fillRect(0, 0, qrSize * 0.3, qrSize * 0.3);
                qrCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                qrCtx.fillRect(qrSize * 0.1, qrSize * 0.1, qrSize * 0.1, qrSize * 0.1);
                qrCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                
                // Top-right corner
                qrCtx.fillRect(qrSize * 0.7, 0, qrSize * 0.3, qrSize * 0.3);
                qrCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                qrCtx.fillRect(qrSize * 0.8, qrSize * 0.1, qrSize * 0.1, qrSize * 0.1);
                qrCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                
                // Bottom-left corner
                qrCtx.fillRect(0, qrSize * 0.7, qrSize * 0.3, qrSize * 0.3);
                qrCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                qrCtx.fillRect(qrSize * 0.1, qrSize * 0.8, qrSize * 0.1, qrSize * 0.1);
                
                // Add text
                qrCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                qrCtx.font = `${qrSize * 0.12}px Arial`;
                qrCtx.textAlign = 'center';
                qrCtx.textBaseline = 'middle';
                qrCtx.fillText(text, qrSize / 2, qrSize / 2);
                
                return canvas;
            }
            
            // Toggle fullscreen
            fullscreenButton.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // Start camera
            async function startCamera() {
                try {
                    const constraints = {
                        video: { 
                            facingMode: "environment",
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    // Wait for video to be ready
                    video.onloadedmetadata = () => {
                        // Start processing frames
                        processFrames();
                    };
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Error accessing camera. Please make sure you've granted camera permissions.");
                }
            }
            
            // Process video frames
            function processFrames() {
                intervalId = setInterval(() => {
                    // Set canvas dimensions to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        // Draw current frame to canvas
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Get image data for QR code scanning
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Check if landscape
                        const isLandscape = canvas.width > canvas.height;
                        updateIndicator(landscapeIndicator, isLandscape, "Landscape");
                        
                        // Scan for QR code
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        let qrCodeFound = false;
                        let qrCodeAligned = false;
                        
                        // Draw static alignment guide with ghost QR code
                        drawAlignmentGuide(ctx, canvas.width, canvas.height);
                        
                        if (code && code.data === "1234") {
                            qrCodeFound = true;
                            updateIndicator(qrIndicator, true, "QR Code");
                            
                            // Calculate QR code position and size
                            const qrLocation = code.location;
                            const topLeft = qrLocation.topLeft;
                            const topRight = qrLocation.topRight;
                            const bottomLeft = qrLocation.bottomLeft;
                            
                            // Calculate the center position of the QR code
                            const qrCenterX = (topLeft.x + topRight.x) / 2 / canvas.width;
                            const qrCenterY = (topLeft.y + bottomLeft.y) / 2 / canvas.height;
                            
                            // Calculate QR code height as percentage of canvas height
                            const qrHeight = Math.abs(bottomLeft.y - topLeft.y) / canvas.height;
                            
                            // Check if QR is ~40% of the height and positioned at ~60% from the top
                            const isSizedCorrectly = Math.abs(qrHeight - 0.4) < 0.1;
                            const isPositionedCorrectly = Math.abs(qrCenterY - 0.6) < 0.1;
                            const isCentered = Math.abs(qrCenterX - 0.5) < 0.1;
                            
                            qrCodeAligned = isSizedCorrectly && isPositionedCorrectly && isCentered;
                            updateIndicator(alignmentIndicator, qrCodeAligned, "Aligned");
                            
                            // Draw QR code outline (dynamic box)
                            ctx.beginPath();
                            ctx.moveTo(qrLocation.topLeftCorner.x, qrLocation.topLeftCorner.y);
                            ctx.lineTo(qrLocation.topRightCorner.x, qrLocation.topRightCorner.y);
                            ctx.lineTo(qrLocation.bottomRightCorner.x, qrLocation.bottomRightCorner.y);
                            ctx.lineTo(qrLocation.bottomLeftCorner.x, qrLocation.bottomLeftCorner.y);
                            ctx.closePath();
                            ctx.lineWidth = 4;
                            ctx.strokeStyle = "#FFFF00";
                            ctx.stroke();
                        } else {
                            updateIndicator(qrIndicator, false, "QR Code");
                            updateIndicator(alignmentIndicator, false, "Aligned");
                        }
                        
                        // Draw border based on orientation
                        ctx.strokeStyle = isLandscape ? "#00FF00" : "#FF0000";
                        ctx.lineWidth = 5;
                        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
                        
                        // Check if all requirements are met for auto-capture
                        if (isLandscape && qrCodeFound && qrCodeAligned) {
                            // Auto-capture the image
                            captureImage();
                        }
                    }
                }, 200);
            }
            
            // Draw alignment guide with ghost QR code
            function drawAlignmentGuide(ctx, width, height) {
                // Calculate box dimensions (40% of height)
                const boxHeight = height * 0.4;
                const boxWidth = boxHeight; // Square box
                const boxX = (width - boxWidth) / 2; // Centered horizontally
                const boxY = (height * 0.6) - (boxHeight / 2); // Center at 60% from top
                
                // Draw alignment box
                ctx.strokeStyle = "#00FFFF";
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 10]);
                ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
                ctx.setLineDash([]);
                
                // Draw ghost QR code
                const ghostQR = createQRCode("1234", boxHeight * 0.8);
                const qrX = boxX + (boxWidth - ghostQR.width) / 2;
                const qrY = boxY + (boxHeight - ghostQR.height) / 2;
                ctx.drawImage(ghostQR, qrX, qrY);
            }
            
            // Update indicator status
            function updateIndicator(element, isSuccess, text) {
                if (isSuccess) {
                    element.className = "indicator success";
                    element.innerHTML = successSvg + `<span class="indicator-text">${text}</span>`;
                } else {
                    element.className = "indicator error";
                    element.innerHTML = errorSvg + `<span class="indicator-text">${text}</span>`;
                }
            }
            
            // Capture image
            function captureImage() {
                // Stop processing frames
                clearInterval(intervalId);
                
                // Get the image data without overlays
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const captureCtx = captureCanvas.getContext('2d');
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                
                const imageData = captureCanvas.toDataURL("image/jpeg");
                
                // Display the captured image
                capturedImage.src = imageData;
                
                // Show the captured view
                capturedView.classList.remove("hidden");
                
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
            
            // Retake button click handler
            retakeButton.addEventListener("click", () => {
                // Hide the captured view
                capturedView.classList.add("hidden");
                
                // Reset indicators
                updateIndicator(landscapeIndicator, false, "Landscape");
                updateIndicator(qrIndicator, false, "QR Code");
                updateIndicator(alignmentIndicator, false, "Aligned");
                
                // Restart camera
                startCamera();
            });
            
            // Continue button click handler
            continueButton.addEventListener("click", () => {
                // Here you would normally submit the image to your server
                // and redirect the user back to the exam
                alert("Image captured successfully! In a real implementation, you would be redirected back to your exam.");
            });
            
            // Handle screen orientation changes
            window.addEventListener('resize', () => {
                // Adjust layout if needed
                if (canvas.width > 0 && canvas.height > 0) {
                    const isLandscape = window.innerWidth > window.innerHeight;
                    updateIndicator(landscapeIndicator, isLandscape, "Landscape");
                }
            });
            
            // Start the camera when the page loads
            startCamera();
        });
    </script>
</body>
</html>
