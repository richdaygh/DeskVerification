<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workspace Documentation</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #video-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin-top: 10px;
    }
    video {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
    }
    .marker {
      position: absolute;
      border: 4px solid red;
      width: 40%;
      height: 40%;
      top: 30%;
      left: 30%;
      box-sizing: border-box;
      pointer-events: none;
    }
    #status {
      margin-top: 10px;
      font-size: 1.2em;
    }
    #captures {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .capture-container {
      text-align: center;
    }
    .capture-container img {
      width: 150px;
      height: auto;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h2>Step Back and Align the QR Code</h2>
  <div id="video-container">
    <video id="video" autoplay playsinline></video>
    <div class="marker" id="marker"></div>
  </div>

  <div id="status">Looking for QR code: <strong>1234</strong></div>

  <div id="captures">
    <div class="capture-container" id="center-capture">
      <strong>Center</strong><br />
    </div>
    <div class="capture-container" id="left-capture">
      <strong>Left</strong><br />
    </div>
    <div class="capture-container" id="right-capture">
      <strong>Right</strong><br />
    </div>
  </div>

  <script type="module">
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

    const correctCode = "1234";
    const video = document.getElementById("video");
    const status = document.getElementById("status");
    const marker = document.getElementById("marker");
    const captured = { center: false, left: false, right: false };
    let currentStage = "center";
    let scanningPaused = false;

    function moveMarker(position) {
      if (position === "center") {
        marker.style.left = "30%";
      } else if (position === "left") {
        marker.style.left = "5%";
      } else if (position === "right") {
        marker.style.left = "65%";
      }
    }

    function captureImage(position) {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const img = new Image();
      img.src = canvas.toDataURL("image/jpeg");
      document.getElementById(`${position}-capture`).appendChild(img);
      captured[position] = true;
    }

    const scanner = new QrScanner(
      video,
      async (result) => {
        if (scanningPaused) return;

        const text = result.data.trim();
        const box = result.cornerPoints;
        const width = Math.hypot(box[0].x - box[1].x, box[0].y - box[1].y);
        const height = Math.hypot(box[1].x - box[2].x, box[1].y - box[2].y);
        const vw = video.videoWidth;
        const vh = video.videoHeight;

        const widthRatio = width / vw;
        const heightRatio = height / vh;
        const isFarEnough = widthRatio < 0.3 && heightRatio < 0.3;

        if (text === correctCode && isFarEnough) {
          if (!captured[currentStage]) {
            scanningPaused = true;

            captureImage(currentStage);
            status.textContent = `âœ… ${currentStage.charAt(0).toUpperCase() + currentStage.slice(1)} view captured`;

            await new Promise((res) => setTimeout(res, 2500)); // wait 2.5 seconds

            if (currentStage === "center") {
              currentStage = "left";
              moveMarker("left");
              status.textContent = "ðŸ“· Please now capture the LEFT view.";
            } else if (currentStage === "left") {
              currentStage = "right";
              moveMarker("right");
              status.textContent = "ðŸ“· Please now capture the RIGHT view.";
            } else if (currentStage === "right") {
              status.textContent = "ðŸŽ‰ All views captured!";
              scanner.stop();
              document.getElementById("video-container").style.display = "none";
              return;
            }

            scanningPaused = false;
          }
        } else if (text === correctCode) {
          status.textContent = "âš ï¸ Please step back to show more of the workspace.";
        } else {
          status.textContent = "âŒ QR not detected or invalid.";
        }
      },
      { returnDetailedScanResult: true }
    );

    QrScanner.hasCamera().then((hasCamera) => {
      if (hasCamera) {
        scanner.start();
        moveMarker(currentStage);
      } else {
        status.textContent = "ðŸš« No camera found.";
      }
    });
  </script>
</body>
</html>
