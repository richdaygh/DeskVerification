<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workspace Capture POC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      font-family: sans-serif;
      color: white;
    }
    #video {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }
    #indicators {
      position: absolute;
      top: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      z-index: 2;
      background: rgba(0,0,0,0.5);
      padding: 5px 0;
    }
    .indicator {
      padding: 5px 10px;
      border: 2px solid red;
      border-radius: 5px;
      background: rgba(255,0,0,0.3);
      transition: all 0.3s;
    }
    .indicator.active {
      border-color: lime;
      background: rgba(0,255,0,0.3);
    }
    #alignmentBox {
      position: absolute;
      z-index: 1;
      border: 4px dashed rgba(255,255,255,0.6);
      box-sizing: border-box;
      aspect-ratio: 1/1;
      width: 60vh;
      height: 60vh;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #ghostQR {
      width: 80%;
      height: 80%;
      opacity: 0.2;
    }
    #overlayBox {
      position: absolute;
      border: 2px solid yellow;
      z-index: 3;
      pointer-events: none;
    }
    #captureDisplay {
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: black;
      z-index: 4;
      display: none;
    }
    #fullscreenOverlay {
      position: absolute;
      z-index: 5;
      background: rgba(0,0,0,0.8);
      color: white;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }
    #fullscreenOverlay button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div id="fullscreenOverlay">
  <h2>Prepare to Capture Your Workspace</h2>
  <p>Turn your phone to landscape and align the camera so the QR code fills the box. We will auto-capture once it's aligned.</p>
  <button onclick="enterFullscreen()">Start</button>
</div>

<video id="video" autoplay playsinline></video>

<div id="indicators">
  <div id="landscape" class="indicator">Landscape</div>
  <div id="qrFound" class="indicator">QR Found</div>
  <div id="aligned" class="indicator">Aligned</div>
</div>

<div id="alignmentBox">
  <img id="ghostQR" src="https://api.qrserver.com/v1/create-qr-code/?data=1234&size=200x200" alt="QR Ghost">
</div>

<canvas id="canvas" style="display:none;"></canvas>
<canvas id="captureDisplay"></canvas>
<div id="overlayBox"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  const TARGET_QR_DATA = "1234";
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let displayCanvas = document.getElementById("captureDisplay");
  let overlayBox = document.getElementById("overlayBox");

  let landscapeInd = document.getElementById("landscape");
  let qrFoundInd = document.getElementById("qrFound");
  let alignedInd = document.getElementById("aligned");

  function setIndicator(element, active) {
    element.classList.toggle("active", active);
  }

  function enterFullscreen() {
    document.getElementById("fullscreenOverlay").style.display = "none";
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    }
    startCamera();
  }

  async function startCamera() {
    let stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      video.play();
      requestAnimationFrame(tick);
    };
  }

  function tick() {
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
      return requestAnimationFrame(tick);
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    let ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let code = jsQR(imageData.data, canvas.width, canvas.height);

    const isLandscape = window.innerWidth > window.innerHeight;
    setIndicator(landscapeInd, isLandscape);

    let found = false;
    let aligned = false;
    if (code && code.data === TARGET_QR_DATA) {
      found = true;
      // Draw overlay
      const minX = Math.min(...code.location.topLeftCorner, code.location.topRightCorner,
                            code.location.bottomLeftCorner, code.location.bottomRightCorner).x;
      const maxX = Math.max(...code.location.topLeftCorner, code.location.topRightCorner,
                            code.location.bottomLeftCorner, code.location.bottomRightCorner).x;
      const minY = Math.min(...code.location.topLeftCorner, code.location.topRightCorner,
                            code.location.bottomLeftCorner, code.location.bottomRightCorner).y;
      const maxY = Math.max(...code.location.topLeftCorner, code.location.topRightCorner,
                            code.location.bottomLeftCorner, code.location.bottomRightCorner).y;
      const boxWidth = maxX - minX;
      const boxHeight = maxY - minY;

      overlayBox.style.left = `${minX}px`;
      overlayBox.style.top = `${minY}px`;
      overlayBox.style.width = `${boxWidth}px`;
      overlayBox.style.height = `${boxHeight}px`;

      // Check alignment: center within 20% of screen center, and height ~60% of canvas height
      const cx = (minX + maxX) / 2;
      const cy = (minY + maxY) / 2;
      const tolerance = 0.15;

      const canvasCenterX = canvas.width / 2;
      const canvasCenterY = canvas.height / 2;
      const heightRatio = boxHeight / canvas.height;

      const isCentered = Math.abs(cx - canvasCenterX) < canvas.width * tolerance &&
                         Math.abs(cy - canvasCenterY) < canvas.height * tolerance;
      const isSized = heightRatio > 0.5 && heightRatio < 0.7;

      aligned = isCentered && isSized;
    } else {
      overlayBox.style.width = overlayBox.style.height = '0px';
    }

    setIndicator(qrFoundInd, found);
    setIndicator(alignedInd, aligned);

    if (found && aligned && isLandscape && !displayCanvas.dataset.captured) {
      captureImage();
      displayCanvas.dataset.captured = "true";
    }

    requestAnimationFrame(tick);
  }

  function captureImage() {
    let dctx = displayCanvas.getContext("2d");
    displayCanvas.width = canvas.width;
    displayCanvas.height = canvas.height;
    dctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    displayCanvas.style.display = "block";
  }
</script>
</body>
</html>
