<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Camera QR Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            text-align: center;
            z-index: 10;
        }
        #status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            text-align: center;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        #captureView {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        #capturedImage {
            max-width: 90%;
            max-height: 70vh;
            border: 2px solid white;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div class="overlay">
            <h1>QR Code Scanner</h1>
            <button id="fullscreenBtn">Fullscreen</button>
        </div>
        
        <div id="status">Camera inactive</div>
    </div>
    
    <div id="captureView" class="hidden">
        <img id="capturedImage" alt="Captured Image">
        <div>
            <button id="retakeBtn">Retake</button>
            <button id="continueBtn">Continue</button>
        </div>
    </div>

    <script>
        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const captureView = document.getElementById('captureView');
        const capturedImage = document.getElementById('capturedImage');
        const retakeBtn = document.getElementById('retakeBtn');
        const continueBtn = document.getElementById('continueBtn');
        
        // Variables
        let stream = null;
        let scanning = false;
        let scanInterval = null;
        
        // Start camera
        function startCamera() {
            // Clear any existing interval
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // Check if getUserMedia is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusText.textContent = "Camera access not supported in this browser";
                return;
            }
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            })
            .then(function(mediaStream) {
                stream = mediaStream;
                video.srcObject = mediaStream;
                
                // Wait for video to be ready
                video.onloadedmetadata = function() {
                    scanning = true;
                    statusText.textContent = "Camera active - scanning for QR code";
                    startScanning();
                };
            })
            .catch(function(err) {
                statusText.textContent = "Camera error: " + err.message;
                console.error("Camera error:", err);
            });
        }
        
        // Start QR code scanning
        function startScanning() {
            scanInterval = setInterval(function() {
                if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
                
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Draw alignment guide
                drawAlignmentGuide();
                
                // Get image data for QR code detection
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Detect QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert"
                });
                
                // If QR code found
                if (code && code.data === "1234") {
                    // Draw QR code outline
                    drawQROutline(code.location);
                    
                    // Check if properly aligned
                    const isAligned = checkAlignment(code);
                    
                    // If aligned, capture image
                    if (isAligned) {
                        setTimeout(captureImage, 500);
                    }
                }
            }, 200);
        }
        
        // Draw alignment guide
        function drawAlignmentGuide() {
            const boxHeight = canvas.height * 0.4;
            const boxWidth = boxHeight;
            const boxX = (canvas.width - boxWidth) / 2;
            const boxY = (canvas.height * 0.6) - (boxHeight / 2);
            
            ctx.strokeStyle = "#00FFFF";
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 10]);
            ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
            ctx.setLineDash([]);
        }
        
        // Draw QR code outline
        function drawQROutline(location) {
            ctx.beginPath();
            ctx.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
            ctx.lineTo(location.topRightCorner.x, location.topRightCorner.y);
            ctx.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
            ctx.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
            ctx.closePath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#FFFF00";
            ctx.stroke();
        }
        
        // Check if QR code is properly aligned
        function checkAlignment(code) {
            const location = code.location;
            
            // Calculate QR dimensions and position
            const topLeft = location.topLeft;
            const topRight = location.topRight;
            const bottomLeft = location.bottomLeft;
            
            // Calculate QR center
            const qrCenterX = (topLeft.x + topRight.x + bottomLeft.x) / 3;
            const qrCenterY = (topLeft.y + topRight.y + bottomLeft.y) / 3;
            
            // Calculate QR height
            const qrHeight = Math.sqrt(
                Math.pow(bottomLeft.x - topLeft.x, 2) + 
                Math.pow(bottomLeft.y - topLeft.y, 2)
            );
            
            // Calculate as percentage of canvas
            const qrHeightPercent = qrHeight / canvas.height;
            
            // Calculate target position (center at 60% of height)
            const targetCenterX = canvas.width / 2;
            const targetCenterY = canvas.height * 0.6;
            
            // Check alignment with tolerance
            const sizeTolerance = 0.15;
            const positionTolerance = 0.1;
            
            const isSizedCorrectly = Math.abs(qrHeightPercent - 0.4) < sizeTolerance;
            const isPositionedCorrectly = 
                Math.abs(qrCenterX - targetCenterX) < canvas.width * positionTolerance &&
                Math.abs(qrCenterY - targetCenterY) < canvas.height * positionTolerance;
            
            return isSizedCorrectly && isPositionedCorrectly;
        }
        
        // Capture image
        function captureImage() {
            if (!scanning) return;
            
            // Stop scanning
            scanning = false;
            clearInterval(scanInterval);
            
            // Create a clean canvas for the captured image
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            captureCanvas.getContext('2d').drawImage(video, 0, 0);
            
            // Set the captured image
            capturedImage.src = captureCanvas.toDataURL('image/jpeg');
            
            // Show capture view
            captureView.classList.remove('hidden');
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }
        
        // Fullscreen toggle
        fullscreenBtn.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error attempting to enable fullscreen:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        });
        
        // Retake button
        retakeBtn.addEventListener('click', function() {
            captureView.classList.add('hidden');
            startCamera();
        });
        
        // Continue button
        continueBtn.addEventListener('click', function() {
            alert('Image captured successfully! In a real implementation, you would be redirected to the exam.');
        });
        
        // Start camera when page loads
        document.addEventListener('DOMContentLoaded', startCamera);
    </script>
</body>
</html>
