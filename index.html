<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workspace Documentation</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
      background-color: #111;
      color: white;
    }
    video {
      width: 100%;
      max-height: 70vh;
      object-fit: cover;
    }
    #overlay {
      position: absolute;
      top: 10px;
      left: 0;
      width: 100%;
      text-align: center;
      z-index: 10;
      font-size: 1.2em;
    }
    #landscape-warning {
      color: yellow;
      background: black;
      padding: 10px;
    }
    #status {
      margin-top: 1em;
      font-size: 1.5em;
    }
    #step-back-warning {
      color: orange;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="landscape-warning" style="display: none;">
      üì± Please rotate your phone to landscape for a better view of your workspace.
    </div>
    <div id="status">üîç Looking for QR code...</div>
    <div id="step-back-warning" style="display: none;">
      ‚¨ÖÔ∏è Please step back to show more of your workspace.
    </div>
  </div>

  <video id="video" autoplay muted playsinline></video>

  <script type="module">
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const stepBackWarning = document.getElementById('step-back-warning');
    const correctCode = "1234";

    function checkOrientation() {
      const warning = document.getElementById('landscape-warning');
      if (window.innerWidth < window.innerHeight) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    }
    window.addEventListener('resize', checkOrientation);
    checkOrientation();

    QrScanner.hasCamera().then(hasCamera => {
      if (!hasCamera) {
        status.textContent = "üö´ No camera found.";
      }
    });

    const scanner = new QrScanner(video, (result) => {
      const text = result.data.trim();
      console.log("QR detected:", text);

      // Check size
      const box = result.cornerPoints;
      const width = Math.hypot(box[0].x - box[1].x, box[0].y - box[1].y);
      const height = Math.hypot(box[1].x - box[2].x, box[1].y - box[2].y);
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;

      const widthRatio = width / videoWidth;
      const heightRatio = height / videoHeight;

      const isFarEnough = widthRatio < 0.3 && heightRatio < 0.3;

      if (text === correctCode && isFarEnough) {
        status.textContent = "‚úÖ QR code detected and valid!";
        stepBackWarning.style.display = "none";
        // Stop scanner to freeze the frame
        scanner.stop();
      } else if (text === correctCode && !isFarEnough) {
        status.textContent = "‚ö†Ô∏è QR code too close.";
        stepBackWarning.style.display = "block";
      } else {
        status.textContent = "‚ùå QR not detected or invalid.";
        stepBackWarning.style.display = "none";
      }
    }, {
      returnDetailedScanResult: true
    });

    QrScanner.listCameras().then(cameras => {
      const preferredCam = cameras.find(cam => cam.label.toLowerCase().includes('back')) || cameras[0];
      scanner.start(preferredCam?.id);
    });
  </script>
</body>
</html>
