<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Proctoring Workspace Validator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            background-color: #000;
        }
        
        #fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            flex-grow: 1;
            overflow: hidden;
        }
        
        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .status-bar {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        
        .status-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .indicator {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .indicator.success {
            background-color: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
        }
        
        .indicator.error {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }
        
        .indicator-icon {
            margin-right: 8px;
        }
        
        .indicator-text {
            font-size: 14px;
            color: #fff;
        }
        
        .fullscreen-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .fullscreen-button:hover {
            background-color: #2563eb;
        }
        
        .captured-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            padding: 16px;
            z-index: 2000;
        }
        
        .captured-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .captured-image-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .captured-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .button-group {
            display: flex;
            gap: 16px;
            padding: 0 16px 16px;
        }
        
        .button-group button {
            flex: 1;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .button-group button.success {
            background-color: #10b981;
        }
        
        .button-group button:hover {
            opacity: 0.9;
        }
        
        .instructions {
            color: white;
            font-size: 12px;
            text-align: center;
            margin-top: 8px;
        }
        
        .hidden {
            display: none !important;
        }

        /* QR Code template for alignment */
        .qr-template {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }
        
        .qr-template div {
            border: 2px solid rgba(0, 255, 255, 0.7);
        }
        
        .qr-template .corner {
            background-color: rgba(0, 255, 255, 0.4);
        }
        
        .qr-template .center {
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(0, 255, 255, 0.7);
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="fullscreen-container">
        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="status-bar">
            <div class="status-title">Workspace Validation</div>
            <div class="status-indicators">
                <div id="landscape-indicator" class="indicator error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span class="indicator-text">Landscape</span>
                </div>
                <div id="qr-indicator" class="indicator error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span class="indicator-text">QR Found</span>
                </div>
                <div id="alignment-indicator" class="indicator error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="indicator-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <span class="indicator-text">Aligned</span>
                </div>
            </div>
            
            <div class="instructions">
                Align the QR code on your screen with the blue template. Hold steady.
            </div>
            
            <button id="fullscreen-button" class="fullscreen-button">
                Enter Fullscreen Mode
            </button>
        </div>
    </div>
    
    <div id="captured-view" class="captured-view hidden">
        <div class="captured-title">Workspace Captured!</div>
        <div class="captured-image-container">
            <img id="captured-image" class="captured-image" alt="Captured Workspace">
        </div>
        <div class="button-group">
            <button id="retake-button">Retake Photo</button>
            <button id="continue-button" class="success">Continue to Exam</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const capturedImage = document.getElementById('captured-image');
            const fullscreenContainer = document.getElementById('fullscreen-container');
            const capturedView = document.getElementById('captured-view');
            const retakeButton = document.getElementById('retake-button');
            const continueButton = document.getElementById('continue-button');
            const fullscreenButton = document.getElementById('fullscreen-button');
            
            // Status indicators
            const landscapeIndicator = document.getElementById('landscape-indicator');
            const qrIndicator = document.getElementById('qr-indicator');
            const alignmentIndicator = document.getElementById('alignment-indicator');
            
            let stream = null;
            let intervalId = null;
            let isFullscreen = false;
            
            // Success indicator SVG
            const successSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #10b981;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            
            // Error indicator SVG
            const errorSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            
            // Fullscreen button click handler
            fullscreenButton.addEventListener('click', () => {
                enterFullscreen();
            });
            
            // Enter fullscreen mode
            function enterFullscreen() {
                if (fullscreenContainer.requestFullscreen) {
                    fullscreenContainer.requestFullscreen();
                } else if (fullscreenContainer.webkitRequestFullscreen) {
                    fullscreenContainer.webkitRequestFullscreen();
                } else if (fullscreenContainer.msRequestFullscreen) {
                    fullscreenContainer.msRequestFullscreen();
                }
                
                isFullscreen = true;
                fullscreenButton.style.display = 'none';
                
                // iOS specific handling
                if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                    video.style.width = '100vw';
                    video.style.height = '100vh';
                }
            }
            
            // Handle fullscreen change
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            function handleFullscreenChange() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                    !document.mozFullScreenElement && !document.msFullscreenElement) {
                    isFullscreen = false;
                    fullscreenButton.style.display = 'block';
                }
            }
            
            // Start camera
            async function startCamera() {
                try {
                    const constraints = {
                        video: { 
                            facingMode: "environment",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    // Wait for video to be ready
                    video.onloadedmetadata = () => {
                        // Start processing frames
                        processFrames();
                    };
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Error accessing camera. Please make sure you've granted camera permissions.");
                }
            }
            
            // Process video frames
            function processFrames() {
                intervalId = setInterval(() => {
                    // Set canvas dimensions to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        // Draw current frame to canvas
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Get image data for QR code scanning
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Check if landscape
                        const isLandscape = canvas.width > canvas.height;
                        updateIndicator(landscapeIndicator, isLandscape, "Landscape");
                        
                        // Draw border based on orientation
                        ctx.strokeStyle = isLandscape ? "#00FF00" : "#FF0000";
                        ctx.lineWidth = 5;
                        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
                        
                        // Draw static alignment guide with ghost QR code
                        drawStaticAlignmentGuide(ctx, canvas.width, canvas.height);
                        
                        // Scan for QR code
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        let qrCodeFound = false;
                        let qrCodeAligned = false;
                        
                        if (code && code.data === "1234") {
                            qrCodeFound = true;
                            updateIndicator(qrIndicator, true, "QR Found");
                            
                            // Calculate QR code position and size
                            const qrLocation = code.location;
                            const topLeft = qrLocation.topLeft;
                            const topRight = qrLocation.topRight;
                            const bottomLeft = qrLocation.bottomLeft;
                            
                            // Calculate the center position of the QR code
                            const qrCenterX = (topLeft.x + topRight.x) / 2 / canvas.width;
                            const qrCenterY = (topLeft.y + bottomLeft.y) / 2 / canvas.height;
                            
                            // Calculate QR code height as percentage of canvas height
                            const qrHeight = Math.abs(bottomLeft.y - topLeft.y) / canvas.height;
                            
                            // Check if QR is ~40% of the height and positioned at ~60% from the top
                            const isSizedCorrectly = Math.abs(qrHeight - 0.4) < 0.1;
                            const isPositionedCorrectly = Math.abs(qrCenterY - 0.6) < 0.1;
                            const isCentered = Math.abs(qrCenterX - 0.5) < 0.1;
                            
                            qrCodeAligned = isSizedCorrectly && isPositionedCorrectly && isCentered;
                            updateIndicator(alignmentIndicator, qrCodeAligned, "Aligned");
                            
                            // Draw dynamic QR code detection box
                            ctx.beginPath();
                            ctx.moveTo(qrLocation.topLeftCorner.x, qrLocation.topLeftCorner.y);
                            ctx.lineTo(qrLocation.topRightCorner.x, qrLocation.topRightCorner.y);
                            ctx.lineTo(qrLocation.bottomRightCorner.x, qrLocation.bottomRightCorner.y);
                            ctx.lineTo(qrLocation.bottomLeftCorner.x, qrLocation.bottomLeftCorner.y);
                            ctx.closePath();
                            ctx.lineWidth = 4;
                            ctx.strokeStyle = "#FFFF00";
                            ctx.stroke();
                            
                            // Draw center point of detected QR code
                            const centerX = (topLeft.x + topRight.x + bottomLeft.x + code.location.bottomRight.x) / 4;
                            const centerY = (topLeft.y + topRight.y + bottomLeft.y + code.location.bottomRight.y) / 4;
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
                            ctx.fillStyle = "#FFFF00";
                            ctx.fill();
                        } else {
                            updateIndicator(qrIndicator, false, "QR Found");
                            updateIndicator(alignmentIndicator, false, "Aligned");
                        }
                        
                        // Check if all requirements are met for auto-capture
                        if (isLandscape && qrCodeFound && qrCodeAligned) {
                            // Auto-capture the image after a short delay to allow the user to hold steady
                            setTimeout(() => {
                                captureImage();
                            }, 500);
                        }
                    }
                }, 200);
            }
            
            // Draw static alignment guide with ghost QR code
            function drawStaticAlignmentGuide(ctx, width, height) {
                // Calculate the position for the alignment guide
                const boxHeight = height * 0.4; // 40% of height
                const boxWidth = boxHeight; // Square box
                const boxX = (width - boxWidth) / 2; // Centered horizontally
                const boxY = (height * 0.6) - (boxHeight / 2); // Center at 60% from top
                
                // Draw the outer alignment box
                ctx.strokeStyle = "#00FFFF";
                ctx.lineWidth = 3;
                ctx.setLineDash([10, 10]);
                ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
                ctx.setLineDash([]);
                
                // Draw ghost QR code inside
                const padding = boxWidth * 0.15;
                const qrSize = boxWidth - (padding * 2);
                const qrX = boxX + padding;
                const qrY = boxY + padding;
                
                // Draw simplified QR pattern
                // Top-left position marker
                ctx.fillStyle = "rgba(0, 255, 255, 0.3)";
                ctx.fillRect(qrX, qrY, qrSize * 0.25, qrSize * 0.25);
                ctx.strokeStyle = "rgba(0, 255, 255, 0.6)";
                ctx.lineWidth = 2;
                ctx.strokeRect(qrX, qrY, qrSize * 0.25, qrSize * 0.25);
                
                // Top-right position marker
                ctx.fillRect(qrX + qrSize * 0.75, qrY, qrSize * 0.25, qrSize * 0.25);
                ctx.strokeRect(qrX + qrSize * 0.75, qrY, qrSize * 0.25, qrSize * 0.25);
                
                // Bottom-left position marker
                ctx.fillRect(qrX, qrY + qrSize * 0.75, qrSize * 0.25, qrSize * 0.25);
                ctx.strokeRect(qrX, qrY + qrSize * 0.75, qrSize * 0.25, qrSize * 0.25);
                
                // Center text for "1234"
                ctx.font = `${qrSize * 0.15}px Arial`;
                ctx.fillStyle = "rgba(0, 255, 255, 0.6)";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("1234", qrX + qrSize / 2, qrY + qrSize / 2);
            }
            
            // Update indicator status
            function updateIndicator(element, isSuccess, text) {
                if (isSuccess) {
                    element.className = "indicator success";
                    element.innerHTML = successSvg + `<span class="indicator-text">${text}</span>`;
                } else {
                    element.className = "indicator error";
                    element.innerHTML = errorSvg + `<span class="indicator-text">${text}</span>`;
                }
            }
            
            // Capture image
            function captureImage() {
                // Stop processing frames
                clearInterval(intervalId);
                
                // Get the image data
                const imageData = canvas.toDataURL("image/jpeg");
                
                // Display the captured image
                capturedImage.src = imageData;
                
                // Show the captured view, hide the camera view
                fullscreenContainer.classList.add("hidden");
                capturedView.classList.remove("hidden");
                
                // Exit fullscreen if active
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => {
                        console.error("Error exiting fullscreen:", err);
                    });
                }
                
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
            
            // Retake button click handler
            retakeButton.addEventListener("click", () => {
                // Hide the captured view, show the camera view
                capturedView.classList.add("hidden");
                fullscreenContainer.classList.remove("hidden");
                
                // Reset indicators
                updateIndicator(landscapeIndicator, false, "Landscape");
                updateIndicator(qrIndicator, false, "QR Found");
                updateIndicator(alignmentIndicator, false, "Aligned");
                
                // Show fullscreen button again if not in fullscreen
                if (!isFullscreen) {
                    fullscreenButton.style.display = 'block';
                }
                
                // Restart camera
                startCamera();
            });
            
            // Continue button click handler
            continueButton.addEventListener("click", () => {
                // Here you would normally submit the image to your server
                // and redirect the user back to the exam
                alert("Image captured successfully! In a real implementation, you would be redirected back to your exam.");
            });
            
            // Screen orientation change handler
            window.addEventListener('orientationchange', () => {
                // Give the screen time to adjust
                setTimeout(() => {
                    // Check if video is ready and update canvas dimensions
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                    }
                }, 300);
            });
            
            // iOS Safari fullscreen workarounds
            window.addEventListener('resize', () => {
                if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                    if (isFullscreen) {
                        // Force video to fill the screen
                        video.style.width = '100vw';
                        video.style.height = '100vh';
                    }
                }
            });
            
            // Start the camera when the page loads
            startCamera();
        });
    </script>
</body>
</html>
